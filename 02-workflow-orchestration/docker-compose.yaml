volumes:
# {{{2
  kestra_postgres_data:
    driver: local
  kestra_data:
    driver: local
# 2}}}

services:  # {{{1
  # ====== Kestra                ======= {{{2
  kestra_postgres:  # {{{3
    image: postgres:18
    volumes:
      - kestra_postgres_data:/var/lib/postgresql
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 10
  # 3}}}

  kestra: # {{{3
    image: kestra/kestra:v1.1
    # pull_policy: always
    # Note that this setup with a root user is intended for development purpose.
    # Our base image runs without root, but the Docker Compose implementation needs root to access the Docker socket
    # To run Kestra in a rootless mode in production, see: https://kestra.io/docs/installation/podman-compose
    user: "root"
    # entrypoint: ["/bin/sh", "-c"]
    # command: >
    #   "/app/kestra plugins install io.kestra.plugin:plugin-gcp:LATEST && /app/kestra server standalone"
    command: server standalone
    volumes:
      - kestra_data:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
    environment:
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra_postgres:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          server:
            basicAuth:
              username: "admin@kestra.io" # it must be a valid email address
              password: Admin1234!
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/app/storage"
          queue:
            type: postgres
          tasks:
            tmpDir:
              path: /tmp/kestra-wd/tmp
          url: http://localhost:8080/
      # STORAGE_EMULATOR_HOST: http://localhost:4443
      # GCS_ENDPOINT: http://storage-emulator:4443
    ports:
      - "8080:8080"
      - "8081:8081"
    depends_on:
      kestra_postgres:
        condition: service_started
      storage-emulator:
        condition: service_started
  # 3}}}
  # 2}}}
  # ====== BigQuery emulator     ====== {{{2
  bigquery:  # {{{3
    platform: linux/x86_64
    image: ghcr.io/recidiviz/bigquery-emulator:latest
    ports:
      - "9050:9050"  # REST server
      - "9060:9060"  # gRPC server
    volumes:
      - ./bq_data:/data
    command: --project=${PROJECT} #--data-from-yaml=/data/data.yaml
  # 3}}}

  bq-ui:  # {{{3
    platform: linux/x86_64
    image: ghcr.io/filipecaixeta/bigquery-emulator-ui:latest
    ports:
      - "8000:8000"
    environment:
      - BIGQUERY_PROJECT_ID=${PROJECT}
      - BIGQUERY_EMULATOR_HOST=bigquery:9050
      - STORAGE_EMULATOR_HOST=storage-emulator:4443
    depends_on:
      - bigquery
      - storage-emulator
  # 3}}}
  # 2}}}
  # ====== GCP services emulator ======= {{{2
  pubsub-emulator:  # {{{3
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: sh -c 'gcloud beta emulators pubsub start --host-port=0.0.0.0:8088'
    ports:
      - "8088:8085"  # port 8085 already assigned to pgadmin on host, so use 8088 instead
    restart: unless-stopped
  # 3}}}

  firestore-emulator:  # {{{3
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: sh -c 'gcloud beta emulators firestore start --host-port=0.0.0.0:8086'
    ports:
      - "8086:8086"
    restart: unless-stopped
  # 3}}}

  firestore-datastore-emulator:  # {{{3
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    environment:
      - MINISERVE_VERSION=0.32.0
      - MINISERVE_PATH=/usr/local/bin/miniserve
    command:
      - sh
      - -c
      - |
        curl -L https://github.com/svenstaro/miniserve/releases/download/v$${MINISERVE_VERSION}/miniserve-$${MINISERVE_VERSION}-$(arch)-unknown-linux-gnu -o $${MINISERVE_PATH} &&
        chmod +x $${MINISERVE_PATH} &&
        mkdir -p /srv &&
        $${MINISERVE_PATH} --port 9999                                              \
          --upload-files                                                            \
          --mkdir                                                                   \
          --enable-tar-gz                                                           \
          --on-duplicate-files=overwrite                                            \
          --route-prefix /fs                                                        \
          --header "Access-Control-Allow-Origin: *"                                 \
          --header "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS"  \
          --header "Access-Control-Allow-Headers: *"                                \
          /srv &
        gcloud beta emulators firestore start --database-mode=datastore-mode --host-port=0.0.0.0:8087
    ports:
      - "8087:8087"
      - "9999:9999"
    restart: unless-stopped
  # 3}}}

  storage-emulator:  # {{{3
    image: fsouza/fake-gcs-server
    command: -scheme http -backend "filesystem" -filesystem-root "/storage" -data /data
    ports:
      - "4443:4443"
    volumes:
      - ./gcs_data:/data
      - ./gcs_storage:/storage
    restart: unless-stopped
  # 3}}}

  gcp-emulator-ui:  # {{{3
    image: ghcr.io/drehelis/gcp-emulator-ui:main
    ports:
      - "9090:80"
    environment:
      - PUBSUB_EMULATOR_URL=pubsub-emulator:8088
      - FIRESTORE_EMULATOR_URL=firestore-emulator:8086
      - DATASTORE_EMULATOR_URL=firestore-datastore-emulator:8087
      - DATASTORE_FILE_SERVER_URL=firestore-datastore-emulator:9999
      - STORAGE_EMULATOR_URL=storage-emulator:4443
    depends_on:
      - pubsub-emulator
      - firestore-emulator
      - firestore-datastore-emulator
      - storage-emulator
    restart: unless-stopped
  # 3}}}
  # 2}}}
# 1}}}
# vim: foldmethod=marker foldlevel=1
